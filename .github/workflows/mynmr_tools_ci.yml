name: Myanmar Tools CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: '*'

jobs:

  # Training Data Project
  training:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          java-version: '8'
      - name: Training Data
        run: |
          cd training
          mvn compile
          mvn test

  # Generate-Converter Project
  gen-conv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          java-version: '8'
      - name: Generate-Converter
        run: |
          cd genconvert
          mvn compile
          mvn test

  # Check consistency between genconvert and compiled converters
  genconvert:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          java-version: '8'
      - name: Consistency genconvert vs compiled
        run: |
          make transcompile
          # There should not be any dirty files:
          git update-index --refresh
          git diff-index HEAD --exit-code

  # CPP Client
  cpp:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: cpp-check
        run: |
          sudo apt-get -y install cmake
          cd clients/cpp
          CXXFLAGS="-w" cmake CMakeLists.txt
          make
          make test

  # Java Client
  java:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          java-version: '7'
      - name: Java client test
        run: |
          cd clients/java
          mvn compile
          mvn test
      
  # PHP Client (minimum PHP version)
  php-min-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup PHP with min version
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.0'
      - uses: "ramsey/composer-install@v1"
      - run: ./vendor/bin/phpunit --configuration clients/php/phpunit.xml

  # PHP Client (latest PHP v7 version)
  #
  # Note: PHP v8+ not supported. Error output for v8:
  #
  #   phpunit/phpunit[6.0.0, ..., 6.5.14] require php ^7.0 -> your php version (8.0.5) does not satisfy that requirement.
  #   Root composer.json requires phpunit/phpunit ^6 -> satisfiable by phpunit/phpunit[6.0.0, ..., 6.5.14].
  #
  php-latest-v7-version:
    name: PHP latest v 7.x version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup PHP with the latest version
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
      - uses: "ramsey/composer-install@v1"
      - run: ./vendor/bin/phpunit --configuration clients/php/phpunit.xml

  # JavaScript Client (latest Node version)
  javascript-latest-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup node
        uses: actions/setup-node@v1
        with:
          node-version: 14.x
      - name: Javascript client test
        run: |
          cd clients/js
          npm ci
          npm run test

  # JavaScript Client (lower npm version)
  javascript-older-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup node
        uses: actions/setup-node@v1
      - name: Javascript client test
        run: |
          cd clients/js
          npm install -g npm@5.7.1
          npm version
          npm ci
          npm run test

  # Python Client
  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Setup Python  
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
      - name: Python client test
        run: |
          cd clients/python
          python setup.py install
          python -m unittest

  # Swift Client on macOS
  swift:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v2
      - name: Configure XCode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '11.5'
      - run: make client-swift-test
